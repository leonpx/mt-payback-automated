<html>
  <head>
    <title>Payback time!</title>
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/jquery.cookie.min.js"></script>
    <link
      rel="stylesheet"
      href="/static/css/pico.min.css"
    />
    <link
      rel="stylesheet"
      href="/static/css/font-awesome.min.css"
    />
  </head>
  <body>
    <main class="container" style="width: 40%">
      <dialog id="ticketholderdialog">
        <article>
          <header>
            <a href="#" id="closemodal" class="close"></a>
            <p id="ticketholdertitle">Add ticket holder</p>
          </header>
          <form id="ticketholderform">
            <input
              type="hidden"
              id="holderdialogmode"
              name="holderdialogmode"
              value="save"
            />
            <input type="hidden" id="holderid" name="holderid" value="1" />
            <div class="grid">
              <label for="firstname">
                First name
                <input type="text" id="firstname" name="firstname" />
              </label>
              <label for="lastname">
                Last name
                <input type="text" id="lastname" name="lastname" />
              </label>
            </div>
            <label for="ssn">Social security number (12 digits)</label>
            <input
              type="text"
              id="ssn"
              name="ssn"
              placeholder="YYYYMMDD-NNNN"
            />
            <label for="ssn">Telephone number</label>
            <input type="text" id="telno" name="telno" />
            <label for="email">Email address</label>
            <input type="text" id="email" name="email" />
            <button type="submit" id="submitholder">Add</button>
          </form>
        </article>
      </dialog>
      <form id="paybackform" autocomplete="off">
        <details>
          <summary id="ticketsummary">Ticket details</summary>
          <section id="ticketdetails">
            <table>
              <tr>
                <td>
                  <label for="ticketholder">Holder</label>
                  <select
                    id="ticketholder"
                    name="ticketholder"
                    style="width: 90%"
                  ></select>
                  <a href="#" class="fa fa-pencil" id="editticketholder"></a>
                  <a
                    href="#"
                    class="fa fa-plus-circle"
                    id="newticketholder"
                  ></a>
                </td>
              </tr>
              <tr>
                <td>
                  <label for="ticket">Number</label
                  ><input
                    type="text"
                    id="ticket"
                    name="ticket"
                  />
                </td>
              </tr>
              <tr>
                <td>
                  <label for="expirydate">Expiry date</label
                  ><input
                    type="date"
                    id="expirydate"
                    name="expirydate"
                  />
                </td>
              </tr>
              <tr>
                <td style="float: right;">
                  <button id="saveticket">Save</button>
                </td>
              </tr>
            </table>
            <div class="grid" style="text-align: center">
              <div id="ticketforminfo"></div>
            </div>
        </section>
        </details>
        <details open>
          <summary>Trip details</summary>
          <section id="trip">
            <table>
              <tr>
                <td colspan="2">
                  <label for="departureLocation">From</label>
                  <select
                    id="departureLocation"
                    name="from"
                    onchange="loadDepartures()"
                  >
                    <option value="U">Uppsala</option>
                    <option value="Cst">Stockholm</option>
                    <option value="Srv">Storvreta</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <label for="arrivalLocation">To</label>
                  <select id="arrivalLocation" name="to">
                    <option value="Cst">Stockholm</option>
                    <option value="Srv">Storvreta</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <label for="departureDate">Departure</label>
                  <div class="grid">
                    <div>
                      <input
                        id="departureDate"
                        type="date"
                        value="{{ today }}"
                        onchange="loadDepartures()"
                      />
                    </div>
                    <div>
                      <select id="departures" name="departure"></select>
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td colspan="2"><input type="submit" value="Submit" /></td>
              </tr>
            </table>
            <div class="grid" style="text-align: center">
              <div id="result"></div>
            </div>
          </section>
        </details>
      </form>
    </main>
  </body>
  <script>
    $(document).ready(() => {
      if (localStorage.getItem("ticketholders")) {
        let ticketholders = JSON.parse(localStorage.getItem("ticketholders"));
        loadTicketHolders(ticketholders);
        loadTicketData(ticketholders[localStorage.getItem("ticketholder")]);
      }

      $("#expirydate").val(localStorage.getItem("expirydate"))
      $("#ticket").val(localStorage.getItem("ticket"))

      loadDepartures();
    });

    $("#closemodal").click(() => {
      $("#ticketholderdialog").removeAttr("open");
    });

    $("#newticketholder").click(() => {
      $("#holderdialogmode").val("save");
      $("#ticketholdertitle").text("Add ticket holder");
      $("#firstname").val("");
      $("#lastname").val("");
      $("#ssn").val("");
      $("#telno").val("");
      $("#email").val("");
      $("#submitholder").text("Add");

      $("#ticketholderdialog").attr("open", "true");
    });

    $("#editticketholder").click(() => {
      let ticketholders = JSON.parse(localStorage.getItem("ticketholders"));
      let ticketholder = ticketholders[$("#ticketholder").val()];

      $("#holderdialogmode").val("edit");
      $("#ticketholdertitle").text("Edit ticket holder");
      $("#firstname").val(ticketholder.firstName);
      $("#lastname").val(ticketholder.lastName);
      $("#ssn").val(ticketholder.identityNumber);
      $("#telno").val(ticketholder.mobileNumber);
      $("#email").val(ticketholder.email);
      $("#submitholder").text("Save");

      $("#ticketholderdialog").attr("open", "true");
    });

    $("#saveticket").click(function (e) {
      localStorage.setItem("ticketholder", $("#ticketholder").val())
      localStorage.setItem("ticket", $("#ticket").val())
      localStorage.setItem("expirydate", $("#expirydate").val())

      $("#ticketforminfo").attr("style", "color:green")
            .text("Details saved"),

      e.preventDefault()
    })

    $("#ticketholderform").submit(function (e) {
      let ticketholders = {};

      if (localStorage.getItem("ticketholders")) {
        ticketholders = JSON.parse(localStorage.getItem("ticketholders"));
      }

      ticketholders[$("#firstname").val()] = {
        firstName: $("#firstname").val(),
        lastName: $("#lastname").val(),
        identityNumber: $("#ssn").val(),
        mobileNumber: $("#telno").val(),
        email: $("#email").val(),
      };

      localStorage.setItem("ticketholders", JSON.stringify(ticketholders));
      loadTicketHolders(ticketholders);
      $("#ticketholderdialog").removeAttr("open");

      e.preventDefault();
    });

    $("#paybackform").submit(function (e) {
      const data = $(this).serialize();

      $.post({
        url: "/api/submit",
        data: data,
        beforeSend: () =>
          $("#result")
            .attr("style", "color:green")
            .attr("aria-busy", "true")
            .text(""),
        success: (data) => $("#result").attr("aria-busy", "false").text(data),
        error: () =>
          $("#result")
            .attr("aria-busy", "false")
            .attr("style", "color:red")
            .text("Request failed"),
      });

      e.preventDefault();
    });

    $("#departureLocation").on("change", (event) => {
      const departureStation = event.target.value;

      $.get({
        url: `/api/arrival_stations/${departureStation}`,
        success: (response) => {
          $("#arrivalLocation").empty();
          $.each(response.stations, (i, val) => {
            $("#arrivalLocation").append(
              $("<option>", {
                value: val.name,
                text: val.longname,
              })
            );
          });
        },
      });
    });

    function loadTicketData(th) {
      $("#ticketsummary").text(
        `Ticket (${th.firstName} ${th.lastName}'s ticket expiring ${localStorage.getItem("expirydate")})`
      );
    }

    function loadTicketHolders(thObj) {
      $("#ticketholder").html("");

      $.each(Object.keys(thObj), (i, key) => {
        $("#ticketholder").append(
          $("<option>", {
            value: thObj[key].firstName,
            text: `${thObj[key].firstName} ${thObj[key].lastName}`,
          })
        );
      });
    }

    function loadDepartures() {
      $.get({
        url: `/api/departures/${$("#departureLocation").val()}/${$(
          "#departureDate"
        ).val()}`,
        dataType: "json",
        success: (response) => {
          $("#departures").empty();
          $.each(response.data, (i, val) => {
            $("#departures").append(
              $("<option>", {
                value: new Date(val).toISOString(),
                text: val.split("T")[1],
              })
            );
          });
          $("#departures").val($("#departures option:last").val());
        },
        error: (e) => console.log(e),
      });
    }
  </script>
</html>
